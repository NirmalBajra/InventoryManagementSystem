@using InventoryManagementSystem.Entity
@using System.Linq
@model List<Sales>

@{
    ViewData["Title"] = "Dashboard";
    ViewData["PageTitle"] = "Dashboard";
    ViewData["MainItem"] = "Dashboard";
    ViewData["SubItem"] = "Overview";
}
<div class="container">
<div class="container-fluid">
    <div class="page-inner">
        <!-- Header -->
        <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
            <div>
                <h3 class="fw-bold mb-3">Dashboard</h3>
            </div>
        </div>

        <!-- Key Performance Indicators -->
        <div class="row">
            <div class="col-sm-6 col-md-3">
                <div class="card card-stats card-round">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-icon">
                                <div class="icon-big text-center icon-primary bubble-shadow-small">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                            </div>
                            <div class="col col-stats ms-3 ms-sm-0">
                                <div class="numbers">
                                    <p class="card-category">Total Sales</p>
                                    <h4 class="card-title">@ViewBag.TotalSales</h4>
                                    <p class="card-category">This Month</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-md-3">
                <div class="card card-stats card-round">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-icon">
                                <div class="icon-big text-center icon-success bubble-shadow-small">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                            </div>
                            <div class="col col-stats ms-3 ms-sm-0">
                                <div class="numbers">
                                    <p class="card-category">Total Revenue</p>
                                    <h4 class="card-title">@($"{ViewBag.TotalRevenue:N2}")</h4>
                                    <p class="card-category">This Month</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-md-3">
                <div class="card card-stats card-round">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-icon">
                                <div class="icon-big text-center icon-info bubble-shadow-small">
                                    <i class="fas fa-receipt"></i>
                                </div>
                            </div>
                            <div class="col col-stats ms-3 ms-sm-0">
                                <div class="numbers">
                                    <p class="card-category">Today's Revenue</p>
                                    <h4 class="card-title">@($"{ViewBag.TodaysRevenue:N2}")</h4>
                                    <p class="card-category">@DateTime.Now.ToString("MMM dd")</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-md-3">
                <div class="card card-stats card-round">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-icon">
                                <div class="icon-big text-center icon-warning bubble-shadow-small">
                                    <i class="fas fa-boxes"></i>
                                </div>
                            </div>
                            <div class="col col-stats ms-3 ms-sm-0">
                                <div class="numbers">
                                    <p class="card-category">Stock Value</p>
                                    <h4 class="card-title">@((ViewBag.TotalStockValue ?? 0).ToString("C"))</h4>
                                    <p class="card-category">@(ViewBag.TotalStockItems ?? 0) Items</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secondary KPI Row -->
        <div class="row">
            <div class="col-sm-6 col-md-3">
                <div class="card card-stats card-round">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-icon">
                                <div class="icon-big text-center icon-secondary bubble-shadow-small">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="col col-stats ms-3 ms-sm-0">
                                <div class="numbers">
                                    <p class="card-category">Total Users</p>
                                    <h4 class="card-title">@(ViewBag.TotalUsers ?? 0)</h4>
                                    <p class="card-category">Registered</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-md-3">
                <div class="card card-stats card-round">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-icon">
                                <div class="icon-big text-center icon-danger bubble-shadow-small">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                            </div>
                            <div class="col col-stats ms-3 ms-sm-0">
                                <div class="numbers">
                                    <p class="card-category">Low Stock</p>
                                    <h4 class="card-title">@(ViewBag.LowStockItems ?? 0)</h4>
                                    <p class="card-category">Items Need Attention</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-md-3">
                <div class="card card-stats card-round">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-icon">
                                <div class="icon-big text-center icon-dark bubble-shadow-small">
                                    <i class="fas fa-times-circle"></i>
                                </div>
                            </div>
                            <div class="col col-stats ms-3 ms-sm-0">
                                <div class="numbers">
                                    <p class="card-category">Out of Stock</p>
                                    <h4 class="card-title">@(ViewBag.OutOfStockItems ?? 0)</h4>
                                    <p class="card-category">Items</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-md-3">
                <div class="card card-stats card-round">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-icon">
                                <div class="icon-big text-center icon-info bubble-shadow-small">
                                    <i class="fas fa-calendar-day"></i>
                                </div>
                            </div>
                            <div class="col col-stats ms-3 ms-sm-0">
                                <div class="numbers">
                                    <p class="card-category">Today's Revenue</p>
                                    <h4 class="card-title">@((ViewBag.TodayRevenue ?? 0).ToString("C"))</h4>
                                    <p class="card-category">@DateTime.Now.ToString("MMM dd")</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row">
            <div class="col-md-8">
                <div class="card card-round">
                    <div class="card-header">
                        <div class="card-head-row">
                            <div class="card-title">Sales & Revenue Trend (Last 7 Days)</div>
                            <div class="card-tools">
                                <a href="@Url.Action("SalesReport", "Chart")" class="btn btn-label-success btn-round btn-sm me-2">
                                    <span class="btn-label">
                                        <i class="fa fa-chart-bar"></i>
                                    </span>
                                    Detailed Report
                                </a>
                                <a href="@Url.Action("ViewSales", "Sales")" class="btn btn-label-info btn-round btn-sm">
                                    <span class="btn-label">
                                        <i class="fa fa-list"></i>
                                    </span>
                                    View All Sales
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="min-height: 375px">
                            <canvas id="salesTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card card-primary card-round">
                    <div class="card-header">
                        <div class="card-head-row">
                            <div class="card-title">Stock by Category</div>
                            <div class="card-tools">
                                <a href="@Url.Action("StockReport", "Chart")" class="btn btn-label-light btn-round btn-sm">
                                    <i class="fa fa-chart-pie"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body pb-0">
                        <div class="chart-container" style="min-height: 300px">
                            <canvas id="stockChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Row -->
        <div class="row">
            <!-- Recent Sales -->
            <div class="col-md-7">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Recent Sales</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Sale ID</th>
                                        <th>Customer</th>
                                        <th>Date</th>
                                        <th>Items</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model != null && Model.Any())
                                    {
                                        foreach (var sale in Model)
                                        {
                                            <tr>
                                                <td>#@sale.SalesId</td>
                                                <td>@sale.CustomerName</td>
                                                <td>@sale.SalesDate.ToString("MMM dd, yyyy")</td>
                                                <td>@sale.SalesDetails.Count</td>
                                                <td><strong>@sale.TotalAmount.ToString("N2")</strong></td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="5" class="text-center">No recent sales found.</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Selling Products -->
            <div class="col-md-5">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Top 5 Selling Products</h4>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            @if (ViewBag.TopSellingProducts != null)
                            {
                                foreach (var product in ViewBag.TopSellingProducts)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        @product.ProductName
                                        <span class="badge bg-primary rounded-pill">@product.TotalQuantity sold</span>
                                    </li>
                                }
                            }
                            else
                            {
                                <li class="list-group-item">No sales data available.</li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock Alerts -->
        <div class="row">
            <div class="col-md-12">
                <div class="card card-round">
                    <div class="card-header">
                        <div class="card-head-row">
                            <h4 class="card-title">Stock Alerts</h4>
                            <div class="card-tools">
                                <a href="@Url.Action("Index", "StockAlert")" class="btn btn-sm btn-link">View All</a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Alert Type</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (ViewBag.StockAlerts != null && ((List<StockAlert>)ViewBag.StockAlerts).Count > 0)
                                    {
                                        foreach (var alert in (List<StockAlert>)ViewBag.StockAlerts)
                                        {
                                            <tr>
                                                <td>
                                                    <strong>@(alert.Product?.ProductName ?? "Unknown Product")</strong>
                                                </td>
                                                <td>
                                                    @if (alert.AlertType == "LowStock")
                                                    {
                                                        <span class="badge bg-warning">Low Stock</span>
                                                    }
                                                    else if (alert.AlertType == "OutOfStock")
                                                    {
                                                        <span class="badge bg-danger">Out of Stock</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-info">@alert.AlertType</span>
                                                    }
                                                </td>
                                                <td>
                                                    <small class="text-muted">@alert.CreatedAt.ToString("MMM dd")</small>
                                                </td>
                                                <td>
                                                    @if (alert.IsRead)
                                                    {
                                                        <span class="badge bg-success">Read</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-primary">New</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">No stock alerts</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Sales Trend Chart
        const salesTrendCtx = document.getElementById('salesTrendChart').getContext('2d');
        const salesTrendChart = new Chart(salesTrendCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Sales Count',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    yAxisID: 'y'
                }, {
                    label: 'Revenue ($)',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Sales Count'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Revenue ($)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });

        // Stock Chart
        const stockCtx = document.getElementById('stockChart').getContext('2d');
        const stockChart = new Chart(stockCtx, {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB',
                        '#FFCE56',
                        '#4BC0C0',
                        '#9966FF',
                        '#FF9F40',
                        '#FF6384',
                        '#C9CBCF'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });

        // Load chart data
        async function loadChartData() {
            try {
                // Load sales trend data
                const salesResponse = await fetch('@Url.Action("GetDashboardChartData")');
                const salesData = await salesResponse.json();
                
                salesTrendChart.data.labels = salesData.map(item => item.date);
                salesTrendChart.data.datasets[0].data = salesData.map(item => item.sales);
                salesTrendChart.data.datasets[1].data = salesData.map(item => item.revenue);
                salesTrendChart.update();

                // Load stock data
                const stockResponse = await fetch('@Url.Action("GetStockChartData")');
                const stockData = await stockResponse.json();
                
                stockChart.data.labels = stockData.map(item => item.category);
                stockChart.data.datasets[0].data = stockData.map(item => item.value);
                stockChart.update();

            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        }

        // Initialize charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadChartData();
        });

        // Auto-refresh data every 5 minutes
        setInterval(loadChartData, 300000);
    </script>
}